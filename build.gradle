plugins {
    id 'org.asciidoctor.convert' version '2.4.0'
    id 'org.ajoberstar.git-publish' version '2.0.0'
    id 'net.researchgate.release' version '2.6.0'
    id 'de.marcphilipp.nexus-publish' version '0.2.0'
}

wrapper {
    gradleVersion = '5.6.4'
}

allprojects {
    group = 'fr.jmini.utils'
}

def buildDate() {
    return new Date().format('yyyy-MM-dd')
}

asciidoctorj {
    version = "$asciidoctorjVersion"
}

asciidoctor {
    sourceDir = file('docs')
    outputDir = file('build/docs')
    resources {
        from('docs') {
            include '*.png'
        }
    }
    attributes = ['revdate'             : "${buildDate()}",
                  'project-version'     : "$version",
                  'attribute-missing'    : 'warn',
                  'source-highlighter'  : 'coderay',
                  'imagesdir'           : '',
                  'toc'                 : 'left',
                  'icons'               : 'font',
                  'toclevels'           : '3',
                  'sectanchors'         : 'true',
                  'idprefix'            : '',
                  'idseparator'         : '-',
                  'docinfo1'            : 'true']
    repositories {
        mavenCentral()
    }
    dependencies {
        asciidoctor "fr.jmini.asciidoctorj:git-link:3.2.1"
    }
}

gitPublish {
    repoUri = 'git@github.com:' + "$githubRepositoryOwner" + '/' + "$githubRepositoryName" + '.git'
    branch = 'gh-pages'

    contents {
        from "${file('build/docs/html5')}"
    }

    preserve {
        include '.nojekyll'
        exclude '.DS_Store'
    }

    commitMessage = "Update the 'gh-pages' branch."
}

nexusPublishing {
    packageGroup = 'fr.jmini'
    username = project.findProperty('sonatypeUser') ?: ''
    password = project.findProperty('sonatypePassword') ?: ''
}

release {
    buildTasks = ['doRelease']
}

task doRelease {
    dependsOn(
        'issue-model:clean',
        'issue-model:publishToNexus',
        'asciidoctor',
        'gitPublishPush'
    )
}